#{extends 'main.html' /}
#{set title:'Explore insights' /}

#{set currentMenu:'menuInsights' /}

<div>
	<ul class="filters">
          <a href="@{Application.insights(null, language)}"     class="categoryFilter #{if category == null}selected#{/if}" >All</a>
	   #{list items:controllers.Application.getCategories(), as:'cat'}
	      <a href="@{Application.insights(cat.id, language)}"   class="categoryFilter #{if category?.id == cat.id}selected#{/if}" >${cat.label}</a>
	   #{/list}
	       <a href="@{Application.insights(category?.id, "en")}">
	           <img alt="english" class="languageFlag #{if language.equals("en")}selected#{/if}" src="@{'/public/images/flags/gb.png'}" />
	       </a>
           <a href="@{Application.insights(category?.id, "fr")}">
	           <img alt="french" class="languageFlag #{if language.equals("fr")}selected#{/if}" src="@{'/public/images/flags/fr.png'}" />
           </a>
    </ul>
    
    <h2>Insights #{if category} in ${category} #{/if}</h2>
    <ul id="insightList">
        #{listInsights insights:insights /}
    </ul>
    
    <div><span onClick="moreInsights()" id="moreResults" style="display:none;"><a href="" onClick="return false">more</a></span></div>

    <script type="text/javascript">
    // check if a "more" button should be displayed
    if( $("#insightList li").length >= ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE} ) {
            $("#moreResults").fadeIn(2000);
       }
    var insightsFrom = ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE};

    /** get more insights */
    function moreInsights() {
        $.ajax( {
            url: moreInsightsAction({"from": insightsFrom #{if category}, "categoryId": ${category.id}#{/if}#{if language}, "language": ${language}#{/if} }),
            success: onMoreInsightsSuccess
        } );
    }
    
    function onMoreInsightsSuccess(content) {
        $("#insightList").append(content);
        insightsFrom += ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE};
        // disable the "more button" if less results than the number to display
        if( $(content).length < ${controllers.Application.NUMBER_INSIGHTS_SEARCHPAGE} ) {
            $("#moreResults").fadeOut(1000);
        }
    }
    </script>

</div>