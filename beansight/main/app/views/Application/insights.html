#{extends 'content.html' /}
#{set 'title'}
    &{'exploreinsights'}
#{/set}

#{set currentMenu:'menuInsights' /}

#{set contentCenterClass:'large' /}

<h2 class="cuf-grb">&{'insightstitle'} #{if category} &{'incategory'} ${category}#{/if}</h2>

<div class="listinsights">
    <ul class="menulistinsights">
        <li class="sortby">Sort by</li>
        <li class="first"><a href="#">suggested</a></li>
    *{
        <li><a href="#">trending</a></li>
        <li><a href="#">incoming</a></li>
     }*
    <li>
	    <div class="filterDropDown">
	    <select name="categoryId" id="c_category">
	       <option value="@{Application.insights(0, langs)}" #{if category == null}selected#{/if}>All</option>
		   #{list items:controllers.Application.getCategories(), as:'cat'}
		       <option value="@{Application.insights(cat.id, langs)}" #{if category && category.id == cat.id}selected#{/if}>${cat.label}</option>
		   #{/list}
		</select>
		</div>
    </li>
        
      *{
        <li><a href="#">Favorites</a></li>
       }* 
    </ul>
    
    <ul id="insightList">
        #{listInsights insights:insights /}
    </ul>

    <div id="moreResults" class="seeall">
        <p><a id="moreInsights" href="#">more</a></p>
    </div>
</div>

<script type="text/javascript">
// TODO check if a "more" button should be displayed
//if( $("#insightList li").length >= ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE} ) {
//        $("#moreResults").fadeIn(2000);
//   }
var insightsFrom = ${controllers.Application.NUMBER_INSIGHTS_SEARCHPAGE};

/** get more insights */
$('#moreInsights').click( function() {
    $.ajax( {
        url: moreInsightsAction(),
        data: {"from":insightsFrom#{if category}, "cat": ${category.id}#{/if}#{if langs}, "lang": [#{list items:langs, as:'langstring'}"${langstring}"#{if !langstring_isLast}, #{/if}#{/list}]#{/if} },
        success: onMoreInsightsSuccess
    } );
    return false;
});

// on category selection, click the link
$('#c_category').selectbox().bind('change', function() {
    window.location.href = $(this).val();
})

function onMoreInsightsSuccess(content) {
    $("#insightList").append(content);
    insightsFrom += ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE};
    // TODO disable the "more button" if less results than the number to display
    //if( $(content).length < ${controllers.Application.NUMBER_INSIGHTS_INSIGHTPAGE} ) {
    //    $("#moreResults").fadeOut(1000);
    //}
}
</script>
