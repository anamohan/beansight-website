#{extends 'content.html' /}
#{set title:insight.content /}

#{set 'moreScripts'}
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <script type='text/javascript'>
      google.load('visualization', '1', {'packages':['annotatedtimeline']});
      
        google.setOnLoadCallback(drawChart);
        function drawChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('datetime', 'Date');
          data.addColumn('number', '&{'showInsight.probabilityChart'}');
          data.addColumn('string', 'title1');
          data.addColumn('string', 'text1');
          data.addRows([
          #{list items:agreeInsightTrends, as:'trend'} 
            [new Date(${trend.trendDate.getTime()}), ${trend.occurenceProbability}*100, undefined, undefined]#{if !trend_isLast},#{/if}
          #{/list}
          ]);

          var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('insightTrendsChart'));
          chart.draw(data, {'thickness': 0, 'max': 100, 'colors': ['#5D7F2C'] ,'displayAnnotations': false, 'displayRangeSelector':false, 'displayZoomButtons':false, 'dateFormat': 'HH:mm MMMM dd, yyyy', 'fill':30});
        }
    </script>
#{/set}

#{set currentMenu:'menuInsights' /}

#{set contentCenterClass:'large' /}

#{insightContainer insight:insight}

<div class="single">
    <div class="s-header">
        <p class="s-intro">#{isConnected}#{followInsightWidget insight:insight /}#{/isConnected}
        &{'creationdate'} ${insight.creationDate.since(true)} &{'createdby'} <a href="@{Application.showUser(insight.creator.userName)}" class="s-author">${insight.creator.userName}</a>
         &{'createdin'} <a href="#" class="link-cat">${insight.category.label}</a></p>
         
        <ul class="list-tags">
            #{isConnected}<li class="link-new"><a href="#" id="showMoreTags">&{'suggesttags'}</a></li>#{/isConnected}
            
            #{list items:insight.tags, as:'tag' }
            <li><a href="#">${tag.label}</a></li>
            #{/list}
        </ul>
        <div id="moreTags" style="display:none;">
        #{form @Application.addTags(insight.uniqueId)}
            <input type="text" name="tagLabelList" id="tagLabelList" />
            <input type="submit" value="&{'addtags'}"/>
        #{/form}
        </div>
        <hr class="clear"/>
    </div>
    <div class="s-content">
        <div class="insight-content">
            <p class="insightdate">&{'showInsights.enddate'} ${insight.endDate.format("dd MMMM yyyy")},</p>
            <h2>${insight.content}</h2>
        </div>
        #{if insight.validated}
            <p class="insightvalidation">
            #{if insight.validationScore > 0.9}
                &{'showInsights.validation.validated.highScore'}
            #{/if}
            #{elseif insight.validationScore > controllers.Application.INSIGHT_VALIDATED_TRUE_MINVAL}
                &{'showInsights.validation.validated.normalScore'}
            #{/elseif}
            #{elseif insight.validationScore > controllers.Application.INSIGHT_VALIDATED_FALSE_MAXVAL}
                &{'showInsights.validation.unknow'}
            #{/elseif}
            #{elseif insight.validationScore > 0.1}
                &{'showInsights.validation.notValidated.normalScore'}
            #{/elseif}
            #{else}
                &{'showInsights.validation.notValidated.lowScore'}
            #{/else}    
            </p>
        #{/if}

        <div class="graphzone">
            <div class="leftgraph">
                #{agree-disagreeWidgetLarge insight:insight, lastUserVote:lastUserVote /}

                <div class="lastvoters">
                    <p>&{'lastvoters'}</p>
                    <ul class="listvoters">
                    #{list items:lastVotes, as:'vote'}
                        <li>#{userMiniAvatarVote vote:vote /}</li>
                    #{/list}
                    </ul>
                    <hr class="clear"/>
                </div>
        
        #{shareInsight insight:insight /}

            </div>
            
            <div class="graphique">
            	<div id="insightTrendsChart" class="analytics-graph" style='width: 316px; height: 148px;'></div>
                <p style="text-align: center; font-size: 12px; margin-top: 5px; font-style: italic;">&{'showInsights.chartTitle'}</p>
            </div>
            <hr class="clear"/>
        </div>

        #{isConnected}
        #{secure.check 'admin'}
        <div class="admin">
            <p>detected language: ${insight.lang}</p>
            <p>ValidationScore : ${insight.getOriginalValidationScore()}</p>
            <p>
                #{form @Admin.setFakeValidationScore(), autocomplete:'off'}
                <label for="fakeValidationScore">Fake ValidationScore :</label> <input type="number" name="fakeValidationScore" id="fakeValidationScore" value="${insight.fakeValidationScore}"> (ex: "0.7", blank for null)
                <input type="hidden" name="insightUniqueId" value="${insight.uniqueId}">
                <input type="submit">
                #{/form}
            </p>
            <a href="@{Admin.hideInsight( insight.id )}" onclick="return confirm('confirm ?');" style="color: red;">hide this prediction</a>
        </div>
        
        #{/secure.check}
        #{/isConnected}

        <div class="commentzone">
            <p class="nbcomments"><span class="cuf-grm">${comments?.size()}</span> <span class="cuf-grb">&{'comments'}</span></p>
            #{isConnected}
            <form class="newcomment" id="addCommentForm">
                
                <div class="comment-author">
                    <a href="@{Application.showUser(controllers.CurrentUser.getCurrentUser().userName)}">
                        ${controllers.CurrentUser.getCurrentUserName()}
                        <span class="img-author">
                            <img src="@{Application.showAvatarSmall( controllers.CurrentUser.getCurrentUser().userName, controllers.CurrentUser.getCurrentUser().avatarHashCode())}"/>
                        </span>
                    </a>
                </div>
                <div class="input-textarea">
                    <textarea cols="20" rows="4" name="content"></textarea>
                </div>
                <input name="uniqueId" type="hidden" value="${insight.uniqueId}"/>

                <hr class="clear"/>
                <div class="input-submit">
                	
                    <button><span class="ajaxloader" style="display:none;"></span><span class="backbutton"></span><span class="txtbutton cuf-newaccount">&{'postcomment'}</span></button>
                    <!--<input type="submit" name="submit-comment" value="Add a comment"/>-->
                </div>
                <hr class="clear"/>
            </form>
            #{/isConnected}

            <div id="commentList" class="list-comments">
            #{list items:comments, as:'comment' }
            #{comment comment:comment /}
            #{/list}
            </div>

        </div>
    </div>
</div>
    
#{/insightContainer}

<script type="text/javascript" charset="utf-8">
// keyboard shortcuts
/*
$(document).bind("keydown", "u", function () {
    window.location.href = "@{Application.insights()}";
});
*/
</script>